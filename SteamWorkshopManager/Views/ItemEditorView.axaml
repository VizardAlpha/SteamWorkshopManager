<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:SteamWorkshopManager.ViewModels"
             xmlns:models="using:SteamWorkshopManager.Models"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="SteamWorkshopManager.Views.ItemEditorView"
             x:DataType="vm:ItemEditorViewModel">

    <Grid RowDefinitions="Auto,*,Auto">
        <!-- Header -->
        <Border Grid.Row="0" Padding="16,12" Background="{DynamicResource SystemControlBackgroundAltHighBrush}">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <Button Command="{Binding CloseCommand}"
                        Content="← Retour"
                        Background="Transparent"/>
                <TextBlock Grid.Column="1" Text="{Binding Title}"
                           FontSize="18" FontWeight="SemiBold"
                           VerticalAlignment="Center" Margin="16,0"/>
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">
                    <Button Command="{Binding ShowDeleteDialogCommand}"
                            Content="Supprimer"
                            Foreground="Red"/>
                    <Button Command="{Binding SaveCommand}"
                            Content="Enregistrer"
                            Classes="accent"
                            IsEnabled="{Binding !IsSaving}"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Tabs -->
        <TabControl Grid.Row="1" SelectedIndex="{Binding SelectedTabIndex}" Margin="16">
            <!-- Tab: Informations -->
            <TabItem Header="Informations">
                <ScrollViewer>
                    <StackPanel Spacing="16" Margin="0,16">
                        <!-- Preview image -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="Image de prévisualisation" FontWeight="SemiBold"/>
                            <Grid ColumnDefinitions="200,*">
                                <Border Width="200" Height="120"
                                        Background="{DynamicResource SystemControlBackgroundBaseLowBrush}"
                                        CornerRadius="4" ClipToBounds="True">
                                    <Panel>
                                        <Image Source="{Binding PreviewImage}" Stretch="UniformToFill"
                                               IsVisible="{Binding PreviewImage, Converter={x:Static ObjectConverters.IsNotNull}}"/>
                                        <TextBlock Text="Aperçu" HorizontalAlignment="Center" VerticalAlignment="Center"
                                                   IsVisible="{Binding PreviewImage, Converter={x:Static ObjectConverters.IsNull}}"/>
                                    </Panel>
                                </Border>
                                <StackPanel Grid.Column="1" Margin="16,0,0,0" VerticalAlignment="Center" Spacing="8">
                                    <TextBlock Text="{Binding PreviewImagePath, TargetNullValue='Aucune image sélectionnée'}"
                                               TextTrimming="CharacterEllipsis"/>
                                    <Button Command="{Binding BrowsePreviewImageCommand}"
                                            Content="Parcourir..."/>
                                </StackPanel>
                            </Grid>
                        </StackPanel>

                        <!-- Title -->
                        <StackPanel Spacing="4">
                            <TextBlock Text="Titre" FontWeight="SemiBold"/>
                            <TextBox Text="{Binding Title}" MaxLength="128"/>
                        </StackPanel>

                        <!-- Description -->
                        <StackPanel Spacing="4">
                            <TextBlock Text="Description" FontWeight="SemiBold"/>
                            <TextBox Text="{Binding Description}"
                                     AcceptsReturn="True"
                                     TextWrapping="Wrap"
                                     Height="150"/>
                        </StackPanel>

                        <!-- Content folder -->
                        <StackPanel Spacing="4">
                            <TextBlock Text="Dossier du contenu" FontWeight="SemiBold"/>
                            <Grid ColumnDefinitions="*,Auto">
                                <TextBox Text="{Binding ContentFolderPath}" IsReadOnly="True"/>
                                <Button Grid.Column="1" Command="{Binding BrowseContentFolderCommand}"
                                        Content="Parcourir..." Margin="8,0,0,0"/>
                            </Grid>
                        </StackPanel>

                        <!-- Tags -->
                        <StackPanel Spacing="4">
                            <TextBlock Text="Tags" FontWeight="SemiBold"/>
                            <ItemsControl ItemsSource="{Binding TagCategories}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate DataType="models:TagCategory">
                                        <Expander Header="{Binding Name}" Margin="0,0,0,4">
                                            <ItemsControl ItemsSource="{Binding Tags}" Margin="16,8,0,0">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <WrapPanel Orientation="Horizontal"/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate DataType="models:WorkshopTag">
                                                        <CheckBox Content="{Binding Name}"
                                                                  IsChecked="{Binding IsSelected}"
                                                                  Margin="0,0,16,4"/>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </Expander>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>

                        <!-- Visibility -->
                        <StackPanel Spacing="4">
                            <TextBlock Text="Visibilité" FontWeight="SemiBold"/>
                            <ComboBox ItemsSource="{Binding VisibilityOptions}"
                                      SelectedItem="{Binding Visibility}"
                                      Width="200"/>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Tab: Changelog -->
            <TabItem Header="Changelog">
                <StackPanel Spacing="8" Margin="0,16">
                    <TextBlock Text="Changelog de la mise à jour" FontWeight="SemiBold"/>
                    <TextBox Text="{Binding NewChangelog}"
                             AcceptsReturn="True"
                             TextWrapping="Wrap"
                             Height="150"
                             Watermark="Décrivez les changements de cette mise à jour..."/>
                    <TextBlock Text="Ce texte sera affiché dans l'historique des mises à jour sur le Workshop."
                               FontSize="11"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                </StackPanel>
            </TabItem>

            <!-- Tab: Versions -->
            <TabItem Header="Versions">
                <StackPanel Spacing="16" Margin="0,16">
                    <TextBlock Text="Gestion des versions"
                               FontSize="14"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>

                    <Border Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                            Padding="16" CornerRadius="4">
                        <StackPanel Spacing="8">
                            <TextBlock Text="Fonctionnalité multi-versions"
                                       FontWeight="SemiBold"/>
                            <TextBlock Text="Cette fonctionnalité permet de publier plusieurs versions de votre mod pour différentes versions du jeu. Vérifiez si elle est activée pour Songs of Syx."
                                       TextWrapping="Wrap"
                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                        </StackPanel>
                    </Border>

                    <ItemsControl ItemsSource="{Binding Versions}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="models:ItemVersion">
                                <Border Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                                        Padding="12" Margin="0,0,0,8" CornerRadius="4">
                                    <Grid ColumnDefinitions="*,Auto">
                                        <StackPanel Spacing="4">
                                            <TextBlock Text="{Binding VersionName}" FontWeight="SemiBold"/>
                                            <TextBlock Text="{Binding GameVersionCompatibility}"
                                                       FontSize="12"
                                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                                        </StackPanel>
                                        <CheckBox Grid.Column="1"
                                                  Content="Toutes versions"
                                                  IsChecked="{Binding IsCompatibleWithAllVersions}"
                                                  IsEnabled="False"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </TabItem>
        </TabControl>

        <!-- Error message -->
        <Border Grid.Row="2"
                IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                Background="#F8D7DA" Padding="16" Margin="16,0,16,16" CornerRadius="4">
            <TextBlock Text="{Binding ErrorMessage}" Foreground="#721C24"/>
        </Border>

        <!-- Delete confirmation overlay -->
        <Border Grid.RowSpan="3"
                IsVisible="{Binding ShowDeleteConfirmation}"
                Background="#80000000">
            <Border Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                    Padding="24" CornerRadius="8"
                    HorizontalAlignment="Center" VerticalAlignment="Center"
                    MinWidth="300">
                <StackPanel Spacing="16">
                    <TextBlock Text="Confirmer la suppression"
                               FontSize="18" FontWeight="SemiBold"/>
                    <TextBlock TextWrapping="Wrap">
                        <Run Text="Êtes-vous sûr de vouloir supprimer"/>
                        <Run Text="{Binding Title}" FontWeight="SemiBold"/>
                        <Run Text="? Cette action est irréversible."/>
                    </TextBlock>
                    <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right">
                        <Button Command="{Binding CancelDeleteCommand}"
                                Content="Annuler"
                                IsEnabled="{Binding !IsDeleting}"/>
                        <Button Command="{Binding ConfirmDeleteCommand}"
                                Content="Supprimer"
                                Foreground="White"
                                Background="Red"
                                IsEnabled="{Binding !IsDeleting}"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Border>
    </Grid>
</UserControl>

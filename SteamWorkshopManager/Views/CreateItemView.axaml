<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:SteamWorkshopManager.ViewModels"
             xmlns:models="using:SteamWorkshopManager.Models"
             xmlns:converters="using:SteamWorkshopManager.Converters"
             xmlns:controls="using:SteamWorkshopManager.Views.Controls"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="SteamWorkshopManager.Views.CreateItemView"
             x:DataType="vm:CreateItemViewModel"
             DragDrop.AllowDrop="True">

    <Grid RowDefinitions="Auto,*,Auto">
        <!-- Header -->
        <Border Grid.Row="0" Padding="24,16" Background="#171a21">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <Button Command="{Binding CancelCommand}"
                        Classes="ghost">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="←" FontSize="16"/>
                        <TextBlock Text="{DynamicResource Cancel}"/>
                    </StackPanel>
                </Button>
                <TextBlock Grid.Column="1" Text="{DynamicResource NewPublication}"
                           FontSize="20" FontWeight="SemiBold"
                           Foreground="White"
                           VerticalAlignment="Center" Margin="24,0"/>
                <Button Grid.Column="2"
                        Command="{Binding CreateCommand}"
                        Classes="accent"
                        Content="{DynamicResource PublishToWorkshop}"
                        IsEnabled="{Binding !IsCreating}"/>
            </Grid>
        </Border>

        <!-- Content -->
        <ScrollViewer Grid.Row="1">
            <StackPanel Spacing="24" Margin="24">
                <!-- Drag & Drop zone -->
                <Border x:Name="DropZone"
                        Background="#1e2328"
                        BorderBrush="#3a4a5a"
                        BorderThickness="2"
                        CornerRadius="12"
                        Padding="40"
                        DragDrop.AllowDrop="True"
                        DragDrop.DragOver="DropZone_DragOver"
                        DragDrop.Drop="DropZone_Drop">
                    <StackPanel HorizontalAlignment="Center" Spacing="16">
                        <Border Width="64" Height="64" CornerRadius="32"
                                Background="#2a3a4a">
                            <TextBlock Text="+" FontSize="28" FontWeight="Bold"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"/>
                        </Border>
                        <TextBlock Text="{DynamicResource DragDropFolder}"
                                   FontSize="16" FontWeight="SemiBold"
                                   HorizontalAlignment="Center"
                                   Foreground="White"/>
                        <TextBlock Text="{DynamicResource Or}"
                                   HorizontalAlignment="Center"
                                   Foreground="#556677"/>
                        <Button Command="{Binding BrowseContentFolderCommand}"
                                Classes="secondary"
                                Content="{DynamicResource BrowseFolders}"
                                HorizontalAlignment="Center"/>
                        <StackPanel Orientation="Horizontal" Spacing="12" HorizontalAlignment="Center">
                            <TextBlock Text="{Binding ContentFolderPath}"
                                       FontSize="12"
                                       Foreground="#8899a6"
                                       MaxWidth="400"
                                       TextTrimming="CharacterEllipsis"
                                       IsVisible="{Binding ContentFolderPath, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                            <TextBlock Text="{DynamicResource NoFolderSelected}"
                                       FontSize="12"
                                       Foreground="#8899a6"
                                       IsVisible="{Binding ContentFolderPath, Converter={x:Static StringConverters.IsNullOrEmpty}}"/>
                            <TextBlock Text="{Binding ContentFolderSize}"
                                       FontSize="12"
                                       Foreground="#66c0f4"
                                       FontWeight="SemiBold"
                                       IsVisible="{Binding ContentFolderSize, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Form -->
                <StackPanel Spacing="20">
                    <!-- Preview image -->
                    <Border Classes="card">
                        <StackPanel Spacing="12">
                            <TextBlock Text="{DynamicResource PreviewImage}" Classes="section-header"/>
                            <Grid ColumnDefinitions="220,*">
                                <Border Width="220" Height="140"
                                        Background="#1e2328"
                                        CornerRadius="8" ClipToBounds="True">
                                    <Panel>
                                        <Image Source="{Binding PreviewImage}" Stretch="UniformToFill"
                                               IsVisible="{Binding PreviewImage, Converter={x:Static ObjectConverters.IsNotNull}}"/>
                                        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center"
                                                    IsVisible="{Binding PreviewImage, Converter={x:Static ObjectConverters.IsNull}}"
                                                    Spacing="8">
                                            <TextBlock Text="[IMG]" FontSize="14" HorizontalAlignment="Center" Opacity="0.3"/>
                                            <TextBlock Text="{DynamicResource NoImage}" FontSize="12" Foreground="#556677"/>
                                        </StackPanel>
                                    </Panel>
                                </Border>
                                <StackPanel Grid.Column="1" Margin="20,0,0,0" VerticalAlignment="Center" Spacing="12">
                                    <StackPanel Orientation="Horizontal" Spacing="12">
                                        <TextBlock Text="{Binding PreviewImagePath}"
                                                   TextTrimming="CharacterEllipsis"
                                                   Foreground="#8899a6"
                                                   FontSize="12"
                                                   MaxWidth="300"
                                                   IsVisible="{Binding PreviewImagePath, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                                        <TextBlock Text="{DynamicResource NoImageSelected}"
                                                   Foreground="#8899a6"
                                                   FontSize="12"
                                                   IsVisible="{Binding PreviewImagePath, Converter={x:Static StringConverters.IsNullOrEmpty}}"/>
                                        <TextBlock Text="{Binding PreviewImageSize}"
                                                   Foreground="#8899a6"
                                                   FontSize="12"
                                                   IsVisible="{Binding PreviewImageSize, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                                    </StackPanel>
                                    <!-- Warning if image > 1 MB -->
                                    <Border Background="#3d2a2a" Padding="8" CornerRadius="4"
                                            BorderBrush="#c23b2e" BorderThickness="1"
                                            IsVisible="{Binding IsImageTooLarge}">
                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                            <TextBlock Text="!" FontWeight="Bold" Foreground="#ff8a80" FontSize="12"/>
                                            <TextBlock Text="{DynamicResource ImageTooLarge}"
                                                       Foreground="#ff8a80" FontSize="12"/>
                                        </StackPanel>
                                    </Border>
                                    <Button Command="{Binding BrowsePreviewImageCommand}"
                                            Classes="secondary"
                                            Content="{DynamicResource ChooseImage}"/>
                                </StackPanel>
                            </Grid>
                        </StackPanel>
                    </Border>

                    <!-- Title -->
                    <StackPanel Spacing="8">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <TextBlock Text="{DynamicResource Title}" Classes="section-header"/>
                            <TextBlock Text="*" Foreground="#c23b2e"/>
                        </StackPanel>
                        <TextBox Text="{Binding Title}" MaxLength="128"
                                 Watermark="{DynamicResource TitlePlaceholder}"/>
                    </StackPanel>

                    <!-- Description -->
                    <StackPanel Spacing="8">
                        <TextBlock Text="{DynamicResource Description}" Classes="section-header"/>
                        <controls:BbCodeEditorControl Text="{Binding Description}"
                                                      EditorHeight="140"
                                                      Watermark="{DynamicResource DescriptionPlaceholder}"/>
                    </StackPanel>

                    <!-- Tags -->
                    <Border Classes="card">
                        <StackPanel Spacing="12">
                            <TextBlock Text="{DynamicResource Tags}" Classes="section-header"/>
                            <ItemsControl ItemsSource="{Binding TagCategories}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate DataType="models:TagCategory">
                                        <Expander Margin="0,0,0,8">
                                            <Expander.Header>
                                                <TextBlock Text="{Binding Name}" FontWeight="SemiBold" Foreground="White"/>
                                            </Expander.Header>
                                            <ItemsControl ItemsSource="{Binding Tags}" Margin="8,12,0,0">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <WrapPanel Orientation="Horizontal"/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate DataType="models:WorkshopTag">
                                                        <CheckBox Content="{Binding Name}"
                                                                  IsChecked="{Binding IsSelected}"
                                                                  Margin="0,0,20,8"/>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </Expander>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <!-- Custom Tags -->
                            <Expander Margin="0,0,0,8" IsExpanded="True">
                                <Expander.Header>
                                    <TextBlock Text="{DynamicResource CustomTags}" FontWeight="SemiBold" Foreground="{StaticResource SteamLightBlueBrush}"/>
                                </Expander.Header>
                                <StackPanel Margin="8,12,0,0" Spacing="12">
                                    <!-- Add new tag -->
                                    <Grid ColumnDefinitions="*,Auto">
                                        <TextBox Text="{Binding NewCustomTag}"
                                                 Watermark="{DynamicResource NewTagPlaceholder}"/>
                                        <Button Grid.Column="1"
                                                Command="{Binding AddCustomTagCommand}"
                                                Classes="accent"
                                                Content="{DynamicResource AddCustomTag}"
                                                Margin="12,0,0,0"/>
                                    </Grid>
                                    <!-- Custom tags list -->
                                    <ItemsControl ItemsSource="{Binding CustomTags}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel Orientation="Horizontal"/>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate DataType="models:WorkshopTag">
                                                <Border Background="#2a3a4a" CornerRadius="4" Padding="8,4" Margin="0,0,8,8">
                                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                                        <CheckBox Content="{Binding Name}"
                                                                  IsChecked="{Binding IsSelected}"/>
                                                        <Button Command="{Binding $parent[ItemsControl].((vm:CreateItemViewModel)DataContext).RemoveCustomTagCommand}"
                                                                CommandParameter="{Binding}"
                                                                Classes="ghost"
                                                                Padding="4,2"
                                                                FontSize="10"
                                                                Foreground="#ff8a80">
                                                            <TextBlock Text="✕"/>
                                                        </Button>
                                                    </StackPanel>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </Expander>
                        </StackPanel>
                    </Border>

                    <!-- Visibility -->
                    <StackPanel Spacing="8">
                        <TextBlock Text="{DynamicResource Visibility}" Classes="section-header"/>
                        <ComboBox ItemsSource="{Binding VisibilityOptions}"
                                  SelectedItem="{Binding Visibility}"
                                  Width="250">
                            <ComboBox.ItemTemplate>
                                <DataTemplate x:DataType="models:VisibilityType">
                                    <TextBlock Text="{Binding Converter={x:Static converters:VisibilityTypeConverter.Instance}}"/>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                    </StackPanel>

                    <!-- Initial changelog -->
                    <StackPanel Spacing="8">
                        <TextBlock Text="{DynamicResource InitialVersionNotes}" Classes="section-header"/>
                        <controls:BbCodeEditorControl Text="{Binding InitialChangelog}"
                                                          EditorHeight="100"
                                                          Watermark="{DynamicResource InitialVersionPlaceholder}"/>
                    </StackPanel>

                    <!-- Dependencies -->
                    <Border Classes="card">
                        <StackPanel Spacing="12">
                            <TextBlock Text="{DynamicResource Dependencies}" Classes="section-header"/>

                            <!-- Input + search button -->
                            <Grid ColumnDefinitions="*,Auto">
                                <TextBox Text="{Binding NewDependencyInput}"
                                         Watermark="{DynamicResource DependencyInputPlaceholder}"/>
                                <Button Grid.Column="1"
                                        Command="{Binding SearchDependencyCommand}"
                                        Classes="accent"
                                        Content="{DynamicResource SearchDependency}"
                                        Margin="12,0,0,0"
                                        IsEnabled="{Binding !IsSearchingDependency}"/>
                            </Grid>

                            <!-- Search progress -->
                            <ProgressBar IsIndeterminate="True"
                                         IsVisible="{Binding IsSearchingDependency}"
                                         Height="4"/>

                            <!-- Preview card -->
                            <Border IsVisible="{Binding PreviewDependency, Converter={x:Static ObjectConverters.IsNotNull}}"
                                    Background="#2a3a4a" Padding="16" CornerRadius="8"
                                    BorderBrush="{StaticResource SteamLightBlueBrush}" BorderThickness="1">
                                <StackPanel Spacing="12">
                                    <TextBlock Text="{DynamicResource ConfirmAddDependency}"
                                               Foreground="#8899a6" FontSize="12"/>
                                    <StackPanel Orientation="Horizontal" Spacing="12">
                                        <TextBlock Text="{Binding PreviewDependency.Title}"
                                                   FontWeight="SemiBold" Foreground="White" FontSize="14"
                                                   VerticalAlignment="Center"/>
                                        <TextBlock Text="{Binding PreviewDependency.PublishedFileId}"
                                                   Foreground="#556677" FontSize="11"
                                                   VerticalAlignment="Center"/>
                                    </StackPanel>
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <Button Command="{Binding ConfirmAddDependencyCommand}"
                                                Classes="accent"
                                                Content="{DynamicResource AddDependency}"/>
                                        <Button Command="{Binding CancelDependencyPreviewCommand}"
                                                Classes="secondary"
                                                Content="{DynamicResource Cancel}"/>
                                    </StackPanel>
                                </StackPanel>
                            </Border>

                            <!-- Error message -->
                            <Border IsVisible="{Binding DependencyError, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                    Background="#3d2a2a" Padding="8" CornerRadius="4"
                                    BorderBrush="#c23b2e" BorderThickness="1">
                                <StackPanel Orientation="Horizontal" Spacing="6">
                                    <TextBlock Text="!" FontWeight="Bold" Foreground="#ff8a80" FontSize="12"/>
                                    <TextBlock Text="{Binding DependencyError}"
                                               Foreground="#ff8a80" FontSize="12"/>
                                </StackPanel>
                            </Border>

                            <!-- Empty state -->
                            <TextBlock Text="{DynamicResource NoDependencies}"
                                       Foreground="#556677"
                                       FontSize="13"
                                       IsVisible="{Binding !Dependencies.Count}"/>

                            <!-- Dependencies list -->
                            <ItemsControl ItemsSource="{Binding Dependencies}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate DataType="models:DependencyInfo">
                                        <Border Background="#2a3a4a" CornerRadius="4" Padding="12,8" Margin="0,0,0,4">
                                            <Grid ColumnDefinitions="*,Auto,Auto">
                                                <StackPanel Spacing="2" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding Title}"
                                                               FontWeight="SemiBold" Foreground="White" FontSize="13"/>
                                                    <TextBlock Text="{Binding PublishedFileId}"
                                                               Foreground="#556677" FontSize="11"/>
                                                </StackPanel>
                                                <!-- Move up/down -->
                                                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="2" VerticalAlignment="Center">
                                                    <Button Command="{Binding $parent[ItemsControl].((vm:CreateItemViewModel)DataContext).MoveDependencyUpCommand}"
                                                            CommandParameter="{Binding}"
                                                            Classes="ghost" Padding="6,2"
                                                            ToolTip.Tip="Move up">
                                                        <TextBlock Text="&#x25B2;" FontSize="10" Foreground="#8899a6"/>
                                                    </Button>
                                                    <Button Command="{Binding $parent[ItemsControl].((vm:CreateItemViewModel)DataContext).MoveDependencyDownCommand}"
                                                            CommandParameter="{Binding}"
                                                            Classes="ghost" Padding="6,2"
                                                            ToolTip.Tip="Move down">
                                                        <TextBlock Text="&#x25BC;" FontSize="10" Foreground="#8899a6"/>
                                                    </Button>
                                                </StackPanel>
                                                <Button Grid.Column="2"
                                                        Command="{Binding $parent[ItemsControl].((vm:CreateItemViewModel)DataContext).RemoveDependencyCommand}"
                                                        CommandParameter="{Binding}"
                                                        Classes="ghost"
                                                        Padding="8,4"
                                                        Foreground="#ff8a80">
                                                    <TextBlock Text="&#x2715;" FontSize="14"/>
                                                </Button>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </StackPanel>
        </ScrollViewer>

        <!-- Error message -->
        <Border Grid.Row="2"
                IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                Background="#3d2a2a" Padding="16" Margin="24,0,24,16" CornerRadius="8"
                BorderBrush="#c23b2e" BorderThickness="1">
            <StackPanel Orientation="Horizontal" Spacing="12">
                <TextBlock Text="!" FontWeight="Bold" Foreground="#c23b2e" FontSize="16"/>
                <TextBlock Text="{Binding ErrorMessage}" Foreground="#ff8a80"/>
            </StackPanel>
        </Border>

        <!-- Loading overlay -->
        <Border Grid.RowSpan="3"
                IsVisible="{Binding IsCreating}"
                Background="#CC000000">
            <Border Background="#2a2e33"
                    Padding="32" CornerRadius="12"
                    HorizontalAlignment="Center" VerticalAlignment="Center"
                    BoxShadow="{StaticResource ToastShadow}">
                <StackPanel Spacing="20" HorizontalAlignment="Center">
                    <ProgressBar IsIndeterminate="True" Width="200" Height="4"
                                 Foreground="{StaticResource AccentGradient}"/>
                    <TextBlock Text="{DynamicResource Publishing}"
                               Foreground="White"
                               FontSize="14"
                               HorizontalAlignment="Center"/>
                </StackPanel>
            </Border>
        </Border>
    </Grid>
</UserControl>
